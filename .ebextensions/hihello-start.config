files:
  "/sbin/appstart":
    mode: "000755"
    owner: webapp
    group: webapp
    content: |
      #!/bin/bash
      set -e

      echo "Activating Python Virtual Environment"
      VENV_PATH="/var/app/current/venv"
      if [ ! -d "$VENV_PATH" ]; then
          echo "Virtual environment not found. Creating a new one..."
          python3 -m venv $VENV_PATH
          echo "Virtual environment created at $VENV_PATH"
      fi

      source $VENV_PATH/bin/activate
      echo "Virtual environment activated at $VENV_PATH"

      REQUIREMENTS_FILE="/var/app/current/requirements.txt"
      if [ -f "$REQUIREMENTS_FILE" ]; then
          echo "Installing dependencies from $REQUIREMENTS_FILE"
          pip install --upgrade pip
          pip install -r $REQUIREMENTS_FILE
          echo "Dependencies installed successfully"
      else
          echo "Error: requirements.txt not found at $REQUIREMENTS_FILE"
          exit 1
      fi

      echo "Starting FastAPI application"
      python -m uvicorn app.main:app --host 0.0.0.0 --port 8000