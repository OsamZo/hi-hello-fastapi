files:
  "/sbin/appstart":
    mode: "000755"
    owner: webapp
    group: webapp
    content: |
      #!/bin/bash
      set -e

      # Poetry가 생성한 가상환경 활성화 및 FastAPI 실행
      POETRY_VENV_PATH=$(poetry env info --path)
      source $POETRY_VENV_PATH/bin/activate
      poetry run uvicorn app.main:app --host 0.0.0.0 --port 8000

option_settings:
  aws:elasticbeanstalk:application:environment:
    ENV: production
    DATABASE_URL: "{DATABASE_URL}"
    PINECONE_API_KEY: "{PINECONE_API_KEY}"
    PINECONE_ENV: "{PINECONE_ENV}"
    PINECONE_HOST: "{PINECONE_HOST}"
    AWS_ACCESS_KEY_ID: "{AWS_ACCESS_KEY_ID}"
    AWS_SECRET_ACCESS_KEY: "{AWS_SECRET_ACCESS_KEY}"
    UPSTAGE_API_KEY: "{UPSTAGE_API_KEY}"

commands:
  # Python 가상환경 생성 및 Poetry 설치
  01_setup_python_env:
    command: |
      curl -sSL https://install.python-poetry.org | python3 -
      export PATH="$HOME/.local/bin:$PATH"
      poetry config virtualenvs.in-project true  # 프로젝트 디렉토리에 .venv 생성
      poetry install --no-root
