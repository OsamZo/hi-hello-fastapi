files:
  "/sbin/appstart":
    mode: "000755"
    owner: webapp
    group: webapp
    content: |
      #!/usr/bin/env bash

      cd /var/app/current || exit 1

      # Python 가상 환경 활성화
      export VIRTUAL_ENV=/var/app/current/venv
      export PATH="$VIRTUAL_ENV/bin:$PATH"

      # 이전 FastAPI 프로세스 종료
      pkill -f "uvicorn" || true

      # FastAPI 애플리케이션 실행
      $VIRTUAL_ENV/bin/uvicorn app.main:app --host 0.0.0.0 --port ${PORT:-8000} --workers 4 >> /var/log/fastapi.log 2>&1

container_commands:
  01_set_log_permissions:
    command: |
      # 로그 파일 생성 및 권한 설정
      sudo touch /var/log/fastapi.log
      sudo chmod 666 /var/log/fastapi.log

option_settings:
  aws:elasticbeanstalk:application:environment:
    ENV: "production"
    DATABASE_URL: "${DATABASE_URL}"
    PINECONE_API_KEY: "${PINECONE_API_KEY}"
    PINECONE_ENV: "${PINECONE_ENV}"
    PINECONE_HOST: "${PINECONE_HOST}"
    AWS_ACCESS_KEY_ID: "${AWS_ACCESS_KEY_ID}"
    AWS_SECRET_ACCESS_KEY: "${AWS_SECRET_ACCESS_KEY}"
    UPSTAGE_API_KEY: "${UPSTAGE_API_KEY}"
    LOG_LEVEL: "info"