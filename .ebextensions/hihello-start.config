files:
  "/sbin/appstart":
    mode: "000755"
    owner: webapp
    group: webapp
    content: |
      #!/usr/bin/env bash
      set -e

      echo "Activating Python 3.12"
      sudo alternatives --set python3 /usr/bin/python3.12

      echo "Activating Poetry Virtual Environment"
      POETRY_VENV_PATH="/var/app/current/.venv"  # 프로젝트 내 .venv 경로
      if [ -d "$POETRY_VENV_PATH" ]; then
          source $POETRY_VENV_PATH/bin/activate
          echo "Poetry virtual environment activated at $POETRY_VENV_PATH"
      else
          echo "Error: Poetry virtual environment not found at $POETRY_VENV_PATH"
          exit 1
      fi

      echo "Starting FastAPI application using Poetry"
      poetry run uvicorn app.main:app --host 0.0.0.0 --port 8000

option_settings:
  aws:elasticbeanstalk:application:environment:
    ENV: production
    DATABASE_URL: "{DATABASE_URL}"
    PINECONE_API_KEY: "{PINECONE_API_KEY}"
    PINECONE_ENV: "{PINECONE_ENV}"
    PINECONE_HOST: "{PINECONE_HOST}"
    AWS_ACCESS_KEY_ID: "{AWS_ACCESS_KEY_ID}"
    AWS_SECRET_ACCESS_KEY: "{AWS_SECRET_ACCESS_KEY}"
    UPSTAGE_API_KEY: "{UPSTAGE_API_KEY}"
