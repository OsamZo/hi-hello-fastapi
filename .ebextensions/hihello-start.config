files:
  "/sbin/appstart":
    mode: "000755"
    owner: webapp
    group: webapp
    content: |
      #!/usr/bin/env bash

      # Python 가상 환경 활성화
      export VIRTUAL_ENV=/var/app/current/venv
      export PATH="$VIRTUAL_ENV/bin:$PATH"

      # 이전 FastAPI 프로세스 종료
      pkill -f "uvicorn" || true

      # FastAPI 애플리케이션 실행
      uvicorn app.main:app --host 0.0.0.0 --port ${PORT:-8000} --workers 4

container_commands:
  01_create_virtual_env:
    command: python3 -m venv /var/app/current/venv
  02_install_poetry_and_dependencies:
    command: |
      source /var/app/current/venv/bin/activate
      curl -sSL https://install.python-poetry.org | python3 -
      export PATH="$HOME/.local/bin:$PATH"
      poetry install --no-root

option_settings:
  aws:elasticbeanstalk:application:environment:
    DATABASE_URL: "${DATABASE_URL}"
    PINECONE_API_KEY: "${PINECONE_API_KEY}"
    PINECONE_ENV: "${PINECONE_ENV}"
    PINECONE_HOST: "${PINECONE_HOST}"
    AWS_ACCESS_KEY_ID: "${AWS_ACCESS_KEY_ID}"
    AWS_SECRET_ACCESS_KEY: "${AWS_SECRET_ACCESS_KEY}"
    UPSTAGE_API_KEY: "${UPSTAGE_API_KEY}"