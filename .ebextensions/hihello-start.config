files:
  # Nginx 설정 파일 복사
  "/etc/nginx/conf.d/proxy.conf":
    mode: "000644"
    owner: root
    group: root
    content: |
      server {
          listen 80;
          location / {
              proxy_pass http://127.0.0.1:8000;
              proxy_http_version 1.1;
              proxy_set_header Upgrade $http_upgrade;
              proxy_set_header Connection "upgrade";
              proxy_set_header Host $host;
          }
      }

container_commands:
  # 1. Python 가상환경 활성화 및 의존성 설치
  01_install_dependencies:
    command: |
      source /var/app/venv/staging-LQM1lest/bin/activate
      pip install --upgrade pip
      pip install poetry
      poetry install --no-root

  # 2. 환경 변수 로드
  02_set_env_vars:
    command: |
      echo "export ENV=production" >> /etc/profile.d/env.sh
      echo "export DATABASE_URL=${DATABASE_URL}" >> /etc/profile.d/env.sh
      echo "export PINECONE_API_KEY=${PINECONE_API_KEY}" >> /etc/profile.d/env.sh
      echo "export PINECONE_ENV=${PINECONE_ENV}" >> /etc/profile.d/env.sh
      echo "export PINECONE_HOST=${PINECONE_HOST}" >> /etc/profile.d/env.sh
      echo "export AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}" >> /etc/profile.d/env.sh
      echo "export AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}" >> /etc/profile.d/env.sh
      echo "export UPSTAGE_API_KEY=${UPSTAGE_API_KEY}" >> /etc/profile.d/env.sh

  # 3. appstart 명령 정의
  03_define_appstart:
    command: |
      echo '#!/bin/bash' > /usr/local/bin/appstart
      echo 'source /var/app/venv/staging-LQM1lest/bin/activate' >> /usr/local/bin/appstart
      echo 'gunicorn -w 4 -k uvicorn.workers.UvicornWorker app:app --bind 0.0.0.0:8000' >> /usr/local/bin/appstart
      chmod +x /usr/local/bin/appstart

  # 4. FastAPI 애플리케이션 실행
  04_run_appstart:
    command: appstart
